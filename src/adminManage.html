<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <title>관리자 - 모터 제어</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <link rel="stylesheet" href="../css/adminstyles.css" />
    </head>
    <body>
        <header>
            <h1>페트몬 장비 관리자</h1>
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: flex-end">
                <button id="btn-maint-device" class="secondary" title="이 기기만 점검 모드 토글">기기 점검</button>
                <button id="btn-maint-global" class="danger" title="전체 점검 모드 토글">전체 점검</button>
                <span class="status-dot" id="conn-dot"></span><span id="conn-text">DISCONNECTED</span>
            </div>
        </header>
        <main>
            <section>
                <h2 style="margin-top: 0">장비 연결</h2>
                <div class="inline">
                    <button id="btn-connect">장비 연결</button>
                    <button id="btn-login" disabled>장비 로그인</button>
                    <button id="btn-query" disabled>속도 조회</button>
                    <button id="btn-help" disabled>도움말</button>
                    <button id="btn-repair" disabled>자가 수리</button>
                    <button id="btn-logout" class="secondary" disabled>로그아웃</button>
                    <button id="btn-go-main" class="secondary" style="background: #444" title="속도 저장 후 메인으로">
                        메인으로
                    </button>
                </div>
                <div style="margin-top: 16px" class="small" id="info-line">시리얼 장비 연결 후 로그인하세요.</div>
            </section>

            <section>
                <h2 style="margin-top: 0">모터 속도 설정</h2>
                <form id="speed-form" class="grid cols-4" onsubmit="return false;">
                    <div class="speed-field">
                        <label>문 열기 속도 (DO)</label>
                        <div class="pair">
                            <input
                                type="number"
                                id="speed-do"
                                min="0"
                                max="255"
                                value="0"
                                placeholder="EEPROM 로딩 중..."
                            />
                            <input type="range" id="speed-do-range" min="0" max="255" value="0" />
                        </div>
                        <div class="adjust-row">
                            <button type="button" class="step-btn-small" data-target="speed-do" data-delta="-10">
                                -10
                            </button>
                            <button type="button" class="step-btn-small" data-target="speed-do" data-delta="-1">
                                -
                            </button>
                            <button type="button" class="step-btn-small" data-target="speed-do" data-delta="1">
                                +
                            </button>
                            <button class="step-btn-small" data-target="speed-do" data-delta="10">+10</button>
                        </div>
                    </div>
                    <div class="speed-field">
                        <label>문 닫기 속도 (DC)</label>
                        <div class="pair">
                            <input
                                type="number"
                                id="speed-dc"
                                min="0"
                                max="255"
                                value="0"
                                placeholder="EEPROM 로딩 중..."
                            />
                            <input type="range" id="speed-dc-range" min="0" max="255" value="0" />
                        </div>
                        <div class="adjust-row">
                            <button type="button" class="step-btn-small" data-target="speed-dc" data-delta="-10">
                                -10
                            </button>
                            <button type="button" class="step-btn-small" data-target="speed-dc" data-delta="-1">
                                -
                            </button>
                            <button type="button" class="step-btn-small" data-target="speed-dc" data-delta="1">
                                +
                            </button>
                            <button class="step-btn-small" data-target="speed-dc" data-delta="10">+10</button>
                        </div>
                    </div>
                    <div class="speed-field">
                        <label>24V 방향1 (D1)</label>
                        <div class="pair">
                            <input
                                type="number"
                                id="speed-d1"
                                min="0"
                                max="255"
                                value="0"
                                placeholder="EEPROM 로딩 중..."
                            />
                            <input type="range" id="speed-d1-range" min="0" max="255" value="0" />
                        </div>
                        <div class="adjust-row">
                            <button type="button" class="step-btn-small" data-target="speed-d1" data-delta="-10">
                                -10
                            </button>
                            <button type="button" class="step-btn-small" data-target="speed-d1" data-delta="-1">
                                -
                            </button>
                            <button type="button" class="step-btn-small" data-target="speed-d1" data-delta="1">
                                +
                            </button>
                            <button class="step-btn-small" data-target="speed-d1" data-delta="10">+10</button>
                        </div>
                    </div>
                    <div class="speed-field">
                        <label>24V 방향2 (D2)</label>
                        <div class="pair">
                            <input
                                type="number"
                                id="speed-d2"
                                min="0"
                                max="255"
                                value="0"
                                placeholder="EEPROM 로딩 중..."
                            />
                            <input type="range" id="speed-d2-range" min="0" max="255" value="0" />
                        </div>
                        <div class="adjust-row">
                            <button type="button" class="step-btn-small" data-target="speed-d2" data-delta="-10">
                                -10
                            </button>
                            <button type="button" class="step-btn-small" data-target="speed-d2" data-delta="-1">
                                -
                            </button>
                            <button type="button" class="step-btn-small" data-target="speed-d2" data-delta="1">
                                +
                            </button>
                            <button class="step-btn-small" data-target="speed-d2" data-delta="10">+10</button>
                        </div>
                    </div>
                </form>
                <div class="inline" style="margin-top: 12px">
                    <button id="btn-refresh-speed" class="secondary" disabled>현재값 동기화(Q)</button>
                    <span class="small" id="auto-speed-msg" style="line-height: 1.4"
                        >입력값 변경 후 약 0.1초 뒤 자동 전송됩니다.</span
                    >
                </div>
            </section>

            <section>
                <h2 style="margin-top: 0">빠른 동작 실행</h2>
                <div class="inline">
                    <button data-cmd="1" class="quick" disabled>문 열기 (1)</button>
                    <button data-cmd="2" class="quick" disabled>문 닫기 (2)</button>
                    <button data-cmd="3" class="quick" disabled>24V 모터 방향1 (3)</button>
                    <button data-cmd="4" class="quick" disabled>24V 모터 방향2 (4)</button>
                    <button data-cmd="5" class="quick" disabled>전체 자동 (5)</button>
                    <button data-cmd="0" class="quick secondary" disabled>센서 상태 (0)</button>
                    <button data-cmd="X" class="quick danger" disabled>긴급 정지 (X)</button>
                </div>
            </section>
        </main>

        <!-- 플로팅 로그 창 -->
        <div id="log-container">
            <div id="log-header">
                <h3>시리얼 로그</h3>
                <div id="log-controls">
                    <div id="log-font-size">
                        <button id="btn-font-smaller" title="글자 작게">A-</button>
                        <button id="btn-font-larger" title="글자 크게">A+</button>
                    </div>
                    <button id="btn-clear-log" class="secondary" title="로그 지우기">Clear</button>
                    <button id="btn-minimize-log" class="secondary" title="최소화">_</button>
                    <button id="btn-close-log" class="secondary" title="닫기">✕</button>
                </div>
            </div>
            <pre id="log"></pre>
            <div id="resize-handle"></div>
        </div>

        <script src="./adminMachine.js"></script>
        <script src="./hotkeys.js"></script>
        <script>
            // 로그 창 드래그 이동 및 크기 조절
            (function () {
                const container = document.getElementById('log-container');
                const header = document.getElementById('log-header');
                const resizeHandle = document.getElementById('resize-handle');
                const logPre = document.getElementById('log');

                let isDragging = false;
                let isResizing = false;
                let startX, startY, startLeft, startTop, startWidth, startHeight;
                let currentFontSize = 11; // 초기 폰트 크기 (픽셀)

                // 드래그 이동
                function startDrag(e) {
                    if (e.target.closest('#log-controls') || e.target.closest('#resize-handle')) return;
                    isDragging = true;
                    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                    startX = clientX;
                    startY = clientY;
                    const rect = container.getBoundingClientRect();
                    startLeft = rect.left;
                    startTop = rect.top;
                    container.style.transition = 'none';
                }

                header.addEventListener('mousedown', startDrag);
                header.addEventListener('touchstart', startDrag, { passive: true });

                // 크기 조절 시작
                function startResize(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    isResizing = true;
                    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                    startX = clientX;
                    startY = clientY;
                    const rect = container.getBoundingClientRect();
                    startWidth = rect.width;
                    startHeight = rect.height;
                    container.style.transition = 'none';
                }

                resizeHandle.addEventListener('mousedown', startResize);
                resizeHandle.addEventListener('touchstart', startResize, { passive: false });

                // 이동 및 크기 조절 처리
                function handleMove(e) {
                    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                    if (isDragging) {
                        const dx = clientX - startX;
                        const dy = clientY - startY;
                        container.style.left = startLeft + dx + 'px';
                        container.style.top = startTop + dy + 'px';
                        container.style.right = 'auto';
                        container.style.bottom = 'auto';
                    } else if (isResizing) {
                        const dx = clientX - startX;
                        const dy = clientY - startY;
                        const newWidth = Math.max(300, startWidth + dx);
                        const newHeight = Math.max(200, startHeight + dy);
                        container.style.width = newWidth + 'px';
                        container.style.height = newHeight + 'px';
                    }
                }

                document.addEventListener('mousemove', handleMove);
                document.addEventListener('touchmove', handleMove, { passive: true });

                function endDragOrResize() {
                    isDragging = false;
                    isResizing = false;
                    container.style.transition = '';
                }

                document.addEventListener('mouseup', endDragOrResize);
                document.addEventListener('touchend', endDragOrResize);

                // 로그 제어 버튼
                document.getElementById('btn-clear-log').addEventListener('click', () => {
                    logPre.textContent = '';
                });

                document.getElementById('btn-minimize-log').addEventListener('click', () => {
                    container.classList.toggle('minimized');
                });

                document.getElementById('btn-close-log').addEventListener('click', () => {
                    container.classList.add('hidden');
                });

                // 글자 크기 조절
                document.getElementById('btn-font-smaller').addEventListener('click', () => {
                    currentFontSize = Math.max(8, currentFontSize - 1);
                    logPre.style.fontSize = currentFontSize + 'px';
                });

                document.getElementById('btn-font-larger').addEventListener('click', () => {
                    currentFontSize = Math.min(20, currentFontSize + 1);
                    logPre.style.fontSize = currentFontSize + 'px';
                });

                // 더블클릭으로 로그창 다시 열기
                document.addEventListener('dblclick', (e) => {
                    if (container.classList.contains('hidden') && e.target === document.body) {
                        container.classList.remove('hidden');
                    }
                });
            })();
        </script>
    </body>
</html>
