<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포인트 적립 API 호출 예제 (POST)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        label, input, button { display: block; margin-bottom: 10px; }
        input[type="text"], input[type="number"] { width: calc(100% - 22px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #apiResponse {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            white-space: pre-wrap; /* JSON 형식 유지 */
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1>포인트 적립 API 호출 (POST 방식)</h1>

        <div>
            <label for="mobileInput">모바일 번호:</label>
            <input type="text" id="mobileInput" value="010-1122-3344" placeholder="예: 01012345678">
        </div>

        <div>
            <label for="countInput">페트병 투입 수량:</label>
            <input type="number" id="countInput" value="5" min="1" placeholder="예: 5">
        </div>

        <div>
            <label for="deviceInput">기기 정보 (device):</label>
            <input type="text" id="deviceInput" value="HWASEONG-001" placeholder="예: SUWON-011 또는 WHASEONG-001">
        </div>

        <div>
            <label for="group_cdInput">기기 이용 지역 (group_cd):</label>suwon(수원), hwaseong(화성), cheonan(천안), bonsa(본사) etc(기타)
            <input type="text" id="groupInput" value="hwaseong" placeholder="예: suwon 또는 hwaseong 또는 cheonan 또는 bonsa">
        </div>

        <div>
            <label for="client_unique_idInput">유닉크 키 정보 (unique key):</label>
            <input type="text" id="client_unique_idInput" value="1234" placeholder="예: SUWON-011 또는 Kiosk-A12">
        </div> 


        <button onclick="callPointApi()">포인트 적립 API 호출</button>

        <h2>API 응답 결과:</h2>
        <div id="apiResponse">
            <!-- API 호출 결과가 여기에 표시됩니다. -->
            응답 대기 중...
        </div>
    </div>

    <script>
        async function callPointApi() {
            const mobile = document.getElementById('mobileInput').value;
            const input_cnt = document.getElementById('countInput').value;
            const device = document.getElementById('deviceInput').value; // device 매개변수 추가
            const group_cd = document.getElementById('groupInput').value; // group_cd 매개변수 추가
            const client_unique_id = secureUuid(`${group_cd}-`); // client_unique_id 매개변수 추가
            //lyc document.setElementById('client_unique_idInput').value = client_unique_id; // 생성된 UUID를 입력란에 표시
            const apiResponseDiv = document.getElementById('apiResponse');

            // 입력값 유효성 검사
            if (!mobile || !input_cnt || !device) {
                apiResponseDiv.innerHTML = '<span class="error">모바일 번호, 투입 수량, 기기 정보를 모두 입력해주세요.</span>';
                return;
            }
            if (isNaN(input_cnt) || parseInt(input_cnt) <= 0) {
                 apiResponseDiv.innerHTML = '<span class="error">유효한 페트병 투입 수량을 입력해주세요 (1 이상).</span>';
                 return;
            }

            // API 엔드포인트 URL
            const apiUrl = 'https://cyclepet.mycafe24.com/point_api.php';

            // POST 요청의 본문 데이터 (JSON 형식)
            const postData = {
                mobile: mobile,
                input_cnt: parseInt(input_cnt), // 숫자로 변환
                device: device, // device 매개변수 추가
                group_cd: group_cd, // group_cd 매개변수 추가
                client_unique_id: client_unique_id // client_unique_id 매개변수 추가
            };

            apiResponseDiv.innerHTML = 'API 호출 중...';

            try {
                // Fetch API를 사용하여 POST 요청 보내기
                const response = await fetch(apiUrl, {
                    method: 'POST', // POST 방식으로 변경
                    headers: {
                        'Content-Type': 'application/json' // JSON 데이터를 보낸다고 명시
                    },
                    body: JSON.stringify(postData) // JavaScript 객체를 JSON 문자열로 변환하여 본문에 담기
                });

                // 응답이 성공적인지 확인 (HTTP 상태 코드 200번대)
                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태 코드: ${response.status}`);
                }

                // 응답을 JSON 형식으로 파싱
                const result = await response.json();

                // 결과값 처리 및 HTML에 표시
                console.log("API 응답:", result);


                let displayHtml = '';
                if (result.status === 'success') {
                    displayHtml += `<p class="success"><strong>${result.message}</strong></p>`;
                    displayHtml += `<p>회원명: ${result.data.user_name}</p>`;
                    displayHtml += `<p>모바일: ${result.data.mobile}</p>`;
                    displayHtml += `<p>투입 수량: ${result.data.input_cnt}개</p>`;
                    displayHtml += `<p>투입 포인트: ${result.data.input_point}개</p>`;
                    displayHtml += `<p>누적 수량: ${result.data.total_cnt}점</p>`;
                    displayHtml += `<p>누적 포인트: ${result.data.total_point}점</p>`;
                    displayHtml += `<p>이용 포인트: ${result.data.used_point}점</p>`;
                    displayHtml += `<p>이용 가능 포인트: ${result.data.available_point}점</p>`;
                    displayHtml += `<p>트랜잭션 ID: ${result.data.inserted_id}</p>`;
                    displayHtml += `<p>기기 정보: ${result.data.device}</p>`; // device 정보도 표시
                    displayHtml += `<p>기기 사용 지역: ${result.data.group_cd}</p>`; // group_cd 정보도 표시
                    displayHtml += `<p>통신 KEY 정보: ${result.data.client_unique_id}</p>`; // client_unique_id 정보도 표시
                    
                } else {
                    displayHtml += `<p class="error"><strong>오류: ${result.message}</strong></p>`;
                }
                displayHtml += `<hr><p>원시 JSON 응답:</p><pre>${JSON.stringify(result, null, 2)}</pre>`;

                apiResponseDiv.innerHTML = displayHtml;

            } catch (error) {
                // 네트워크 오류 또는 JSON 파싱 오류 처리
                console.error("API 호출 중 오류 발생:", error);
                apiResponseDiv.innerHTML = `<span class="error">API 호출 중 오류가 발생했습니다: ${error.message}</span>`;
            }
        }

        // 페이지 로드 시 초기 메시지 설정
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiResponse').innerHTML = '버튼을 눌러 API를 호출하세요.';
        });

        // 더 안전하고 표준적인 방법 (권장)
        // 브라우저에서 UUID v4를 얻는 방법 (암호학적 난수 기반)
        
        function secureUuid(prefix = '') {
            // 최신 브라우저에서는 crypto.randomUUID() 사용 가능
            if (window.crypto && typeof crypto.randomUUID === 'function') {
                return prefix + crypto.randomUUID();
            }
            // 구형 브라우저용 폴백: crypto.getRandomValues로 직접 생성 (표준 UUID v4 형식)
            const buf = new Uint8Array(16);
            crypto.getRandomValues(buf);
            // RFC4122 v4 변형 비트 설정
            buf[6] = (buf[6] & 0x0f) | 0x40;
            buf[8] = (buf[8] & 0x3f) | 0x80;
            const hex = Array.from(buf).map(b => b.toString(16).padStart(2, '0')).join('');
            const uuid = `${hex.substr(0,8)}-${hex.substr(8,4)}-${hex.substr(12,4)}-${hex.substr(16,4)}-${hex.substr(20,12)}`;
            //lyc document.setElementById('client_unique_idInput').innerHTML = client_unique_id;
            return prefix + uuid;
        }
    </script>

</body>
</html>